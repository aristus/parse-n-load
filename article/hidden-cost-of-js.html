<style>
  * {
    font-family: "helvetica neue";
  }

  body {
    width: 800px;
    margin: 15px;
  }

  p {
    line-height: 1.4em;
    margin: 0.4em 0 1em 0;
  }

  h1, h2, h3 {
    font-weight: normal;
    margin:0;
    letter-spacing: 0.07em;
  }
  h3 {
    color: #900;
  }
  h2 {
    color: #555;
  }

  table.chart {
    cell-padding: 0;
    cell-spacing: 0;
    border-bottom: solid 1px #ddd;
    border-right: solid 1px #ddd;
    border-collapse: collapse;
  }

  table.chart td {
    border-top: solid 1px #ddd;
    border-left: solid 1px #ddd;
    margin:0;
    font-size: 10pt;
    padding: 4px;
    vertical-align: center;
    text-align: center;
    height: 40px;
    width: 60px;
  }

  table.chart th {
    padding: 4px;
    background: #dad4d8;
    border-right: solid 1px #eee;
    font-weight: bold;
    font-size: 10pt;
  }

  table.chart td.v {
    white-space: nowrap;
    text-align: center;
    border: none;
    font-size: 10pt;
    background: #dad4d8;
    border-bottom: solid 1px #eee;
  }

  div.caption {
    font-size: 10pt;
    font-style: italic;
    margin: 10px;
    text-align:center;
  }
  div.figure {
    text-align: center;
    margin-bottom: 20px;
  }

  td.asterix {
    color: #999;
  }
  th.asterix {
    color: #666;
  }


  div.bar {
    height: 4px;
    background:#aaa;
    position:relative;
    top: 16px;
    left: -4px;
    display:none; /* not sure if the embedded bar chart is useful */
  }
  td.asterix div.bar {
    background-color: #bbb;
  }

  div.aside {
    font-size: 8pt;
    font-weight: normal;
  }
</style>

<h2>A Hidden Cost of Javascript</h2>

<p><b>Hello, this is unfinished. If you'd like to help out, please email me at carlos [a] bueno [d] org. Thanks!</b></p>

<p>Any savvy web developer can tell you how many kilobytes their code consumes. They bundle, <a href="http://developer.yahoo.com/performance/rules.html#minify">minify</a>, <a href="http://developer.yahoo.com/performance/rules.html#gzip">compress</a> and tune the data sent out to within an inch of its life. Wire weight is easy to measure and has a direct impact on your application's launch time. But how many milliseconds does it take the user's computer to <i>parse and load</i> your code once it's arrived? What differences are there between CPUs, operating systems, browsers and plugins? What speed leaks are we overlooking?</p>

<h3>Performance is Feature 0</h3>
<p>As you look at the data below, keep in mind three things:</p>
<ol>
<li>Parse-n-load time comes down to the speed of the CPU and RAM</li>
<li>The fastest CPUs aren't getting much faster</li>
<li><i>The average CPU is getting slower</i></li>
</ol>

<p>Even if you look at just sexy new hardware it's hard to ignore the CPU speed shift: there are about 50 million netbooks and 43 million iPhones out there, alongside 10-15 million Android devices. Almost all of them are in the 600-1,600 MHz range and have less than 512MB of RAM. A juicy, growing slice of the market wants to use your software on the equivalent of a desktop from 1998. This includes rich Westerners as well as law students in Argentina who prefer small and cheap computers because of exchange rates and import tariffs. If your software runs slower than your competitor's, you lose.</p>

<h3>The Test</h3>

<p>The test harness loads a given block of Javascript from a local file over and over and measures the setup time. My test subjects were the Yahoo User Interface (<a href="http://developer.yahoo.com/yui/3">YUI</a>) libraries, Scriptaculous, jQueryUI, and 280North's Cappuccino framework. By themselves these Javascript files don't do anything except register classes, functions and variables. I've also included the main Javascript application code from popular applications like GitHub and Yahoo Mail.</p>

<p>The test is as simple as can be: record a start time, load the script, record the end time, and repeat over 1,000 iterations. The tests were run on recently-booted machinea with no other programs running. You can <a href="http://github.com/aristus/parse-n-load">check out the project on GitHub</a> and play along at home.</p>


<h3>MacBook Pro 2.26GHz, OSX 10.5.8</h3><br/>

<table class="chart" cellspacing="0">
  <tr>
  <th style="background:none"></th>
  <th>Chrome <div class="aside">5.0.307.7</div></th>
  <th>Safari 4 <div class="aside">4.0.3</div></th>
  <th>Firefox 3 <div class="aside">3.0.14</div></th>
  <th>Firefox 3.5 <div class="aside">3.5.3</div></th>
  <th>Firefox 3.6 <div class="aside">3.6</div></th>
  <th class="asterix">Opera 10*</th>
  <th class="asterix">Safari 3*</th>
  </tr>

  <tr>
    <td class="v"><b>YUI3</b> <div class="aside">raw, 1,355KB</div></td>
    <td>62</td>
    <td>98</td>
    <td>114</td>
    <td>128</td>
    <td>115</td>
    <td class="asterix">112</td>
    <td class="asterix">129</td>
  </tr>
  <tr>
    <td class="v"><b>YUI3</b> <div class="aside">minified, 311KB</div></td>
    <td>31</td>
    <td>47</td>
    <td>78</td>
    <td>94</td>
    <td>83</td>
    <td class="asterix">62</td>
    <td class="asterix">111</td>
  </tr>
  <tr>
    <td class="v"><b>YUI2</b> <div class="aside">raw, 1,510KB</div></td>
    <td>23</td>
    <td>153</td>
    <td>131</td>
    <td>142</td>
    <td>137</td>
    <td class="asterix">116</td>
    <td class="asterix">150</td>
  </tr>
  <tr>
    <td class="v"><b>YUI2</b> <div class="aside">minified, 390KB</div></td>
    <td>11 </td>
    <td>110</td>
    <td>77</td>
    <td>105</td>
    <td>102</td>
    <td class="asterix">74</td>
    <td class="asterix">125</td>
  </tr>

  <tr>
    <td class="v"><b>Scriptaculous</b><div class="aside">minified, 159KB</div></td>
    <td>7</td>
    <td class="asterix">50*</td>
    <td>63</td>
    <td>91</td>
    <td>71</td>
    <td class="asterix"></td>
    <td class="asterix"></td>
  </tr>


  <tr>
    <td class="v"><b>GitHub</b><div class="aside">minified, 211KB</div></td>
    <td>4 </td>
    <td>63</td>
    <td>67</td>
    <td>80</td>
    <td>66</td>
    <td class="asterix"></td>
    <td class="asterix"></td>
  </tr>
</table>
<div class="caption">
  <p>Table 0: Parse-and-load times in milliseconds for various Javascript libraries and browsers, 95th percentile mean. MacBook Pro 2.26 GHz Intel Core 2 Duo with 4GB of 1GHz DDR3 RAM.
<br/>* Incomplete test, only 100 iterations. See "Tragic Opera" below.</p>
</div>


<h3>Presario R3000 1.6GHz, WinXP SP3</h3><br/>
<table class="chart" cellspacing="0">
  <tr>
  <th style="background:none"></th>
  <th>Chrome <div class="aside">4.0.249.89</div></th>
  <th>Safari 4 <div class="aside">4.0.2</div></th>
  <th>Firefox 3 <div class="aside">3.0.11</div></th>
  <th>Firefox 3.5 <div class="aside">3.5.2</div></th>
  <th>Firefox 3.6 <div class="aside">3.6</div></th>
  <th>IE 7 <div class="aside">7.X</div></th>
  </tr>

  <tr>
    <td class="v"><b>YUI3</b> <div class="aside">raw, 1,355KB</div></td>
    <td></td>
    <td></td>
    <td>163</td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td class="v"><b>YUI3</b> <div class="aside">minified, 311KB</div></td>
    <td></td>
    <td></td>
    <td>119</td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td class="v"><b>YUI2</b> <div class="aside">raw, 1,510KB</div></td>
    <td></td>
    <td></td>
    <td>187</td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
  <tr>
    <td class="v"><b>YUI2</b> <div class="aside">minified, 390KB</div></td>
    <td></td>
    <td></td>
    <td>140</td>
    <td></td>
    <td></td>
    <td></td>
  </tr>

  <tr>
    <td class="v"><b>Scriptaculous</b><div class="aside">minified, 159KB</div></td>
    <td></td>
    <td></td>
    <td>89</td>
    <td></td>
    <td></td>
    <td></td>
  </tr>

  <tr>
    <td class="v"><b>GitHub</b><div class="aside">minified, 211KB</div></td>
    <td></td>
    <td></td>
    <td>89</td>
    <td></td>
    <td></td>
    <td></td>
  </tr>
</table>
<div class="caption">
  <p>Table 1: Parse-and-load, 95th percentile mean. Compaq Presario R3000 at 1.6GHz, Windows XP SP3 and 512MB RAM.</p>
</div>


<h3>MacBook Air 1.6GHz, OSX 10.5.8</h3><br/>

<table class="chart" cellspacing="0">
  <tr>
  <th style="background:none"></th>
  <th>Chrome <div class="aside">5.0.307.7</div></th>
  <th>Safari 4 <div class="aside">4.0.2</div></th>
  <th>Firefox 3 <div class="aside">3.0.12</div></th>
  <th>Firefox 3.5 <div class="aside">3.5.2</div></th>
  <th>Firefox 3.6 <div class="aside">3.6</div></th>
  </tr>

  <tr>
    <td class="v"><b>YUI3</b> <div class="aside">raw, 1,355KB</div></td>
    <td>19</td>
    <td>92</td>
    <td>219</td>
    <td>234</td>
    <td></td>
  </tr>
  <tr>
    <td class="v"><b>YUI3</b> <div class="aside">minified, 311KB</div></td>
    <td>8</td>
    <td>72</td>
    <td>178</td>
    <td>170</td>
    <td></td>
  </tr>
  <tr>
    <td class="v"><b>YUI2</b> <div class="aside">raw, 1,510KB</div></td>
    <td>24</td>
    <td>251</td>
    <td>301</td>
    <td>268</td>
    <td></td>
  </tr>
  <tr>
    <td class="v"><b>YUI2</b> <div class="aside">minified, 390KB</div></td>
    <td>15</td>
    <td>182</td>
    <td>176</td>
    <td>190</td>
    <td></td>
  </tr>

  <tr>
    <td class="v"><b>Scriptaculous</b><div class="aside">minified, 159KB</div></td>
    <td>10</td>
    <td>56</td>
    <td>97</td>
    <td>163</td>
    <td></td>
  </tr>

  <tr>
    <td class="v"><b>GitHub</b><div class="aside">minified, 211KB</div></td>
    <td>5</td>
    <td>77</td>
    <td>131</td>
    <td>130</td>
    <td></td>
  </tr>
</table>
<div class="caption">
  <p>Table 1: Parse-and-load, 95th percentile mean. MacBook Air 1.6 GHz Intel Core 2 Duo with 2GB of 1GHz DDR2 RAM.</p>
</div>

<p>You can see there are some large differences between different browsers on the same hardware and OS. Firefox 3.5 is a few points slower than 3.0, but 3.6 improved on that. Minification appears to help parse-n-load in addition to network transmission time. I didn't include standard deviations because aside from some pathological cases they were small.</p>


<h3>The Curious Case of Chrome</h3>
<p>While Google Chrome appears to be an order of magnitude faster at parse-n-load the truth may be a little more complex. On my MacBook Air this benchmark often produces sharp cliffs. That might be the V8 engine's <a href="http://en.wikipedia.org/wiki/Inline_caching">inline caching</a> kicking in. Or perhaps the CPU leaves low-power mode in response to demand. Given that none of the other browsers on this machine have the same cliff, though, it would have to mean that their bottleneck is something other than raw MIPS. I'm leaning towards the inlining theory but if someone more knowledgeable can speak up, please do.</p>

<div class="figure">
  <img src="chrome-cliff.png" />
  <div class="caption">Figure 0: On a Macbook Air, Chrome's V8 Javascript engine has two speeds: fast and <b>very</b> fast.</div>
</div>

<p>Comparing the speed of different libraries in the same browser is trickier because they all have different feature sets. For example, as of this writing YUI2 is much more complete than YUI3, and I only included a few widgets like DataTable and TreeView to create a slug of Javascript of a comparable size.</p>



<h3>Debugging the Benchmark</h3>
<p>The first problem that came up was different blocking behavior between browsers. In Safari 4 (but not 3) if you create a script tag that points to an external file, that action will block, ie, wait until that file is completely parsed and loaded. This makes timing it very easy. In Firefox, however, this action asynchronous: the statement that creates the script element returns immediately and the file is loaded in a separate thread. This means you have to set up a callback in the separate thread to both measure elapsed time and kick off the next iteration of the test. You have to be <a href="http://paulbarry.com/articles/2009/08/30/tail-call-optimization">careful not the blow the stack</a> with too many nested function calls. Chrome is also asynchronous and has an altogether different stack behavior. If all that wasn't enough, browsers have very different memory allocation behavior, of which more (oh, much more) below.</p>

<h3>Adventures in Garbage Collecting</h3>

<p>Every browser seems to have a different system for allocating memory while parsing Javascript code. When you graph the results from Safari 4 this is what you will see:</p>

<div class="figure">
  <img src="spiky-garbage.png" />
  <div class="caption">Figure 1: the effects of GC halts</div>
</div>


<p>Interesting. All of the source files in the benchmark are local so that's not I/O wait. The regularity of huge spikes suggests that the browser is pausing every so often to free up memory via garbage collection. When you remove those spikes another interesting patterns shows up. Here is the same graph with the top 5% of datapoints removed:</p>

<div class="figure">
  <img src="sawtooth.png" />
  <div class="caption">Figure 2: 95th percentile graph of Javascript load times in Safari 4</div>
</div>

<p>It appears that the parse-n-load time of a given piece of Javascript in Safari 4 will increase linearly with the amount of garbage. The load time can grow as much as 3X longer than normal before GC kicks in. I'm not certain whether this is an artifact of the benchmark or if it actually happens a lot during real-world use. Other browsers exhibit similar halt-the-world GC behavior but only Safari 4 and Opera 10.5alpha have this sawtooth. Firefox's graph stays fairly horizontal but has many more small spikes:</p>


<div class="figure">
  <img src="firefox-35.png" />
  <div class="caption">Figure 3: 95th percentile graph of Javascript load times in Firefox 3.5.3</div>
</div>



<h3>A Tragic Opera</h3>
<p>The results for Opera 10.0 and Safari 3 have asterisks because I couldn't get them to run the complete test. Opera got steadily slower up to 250 iterations after which it started serious thrashing and had to be killed. Opera 10.5alpha reportedly has a new Javascript engine, and some quick tests show more sawtooth-like behavior, but it still is not able to complete the full 1,000 iterations before spinning out of control.</p>

<div class="figure">
  <img src="oh-opera.png" />
  <img src="opera-10-ram.png" />
  <div class="caption">Figure 4: Opera 10 choking on the parse-n-load benchmark</div>
</div>

<p>Safari 3 hit the wall even earlier, triggering an Out-of-Memory error after a couple hundred iterations. For some reason I had similar problems with Safari 4 and Scriptaculous, which is why that cell has an asterisk.<p>

<div class="figure">
  <img src="safari-3-ram.png" />
  <img src="safari-3.png" />
  <div class="caption">Figure 5: Safari 3's memory leaks</div>
</div>


<h3>Try this at home</h3>

<p>The <a href="http://github.com/aristus/parse-n-load">Parse-N-Load benchmark</a> is open source and free for use. It's early and I'm sure there are bugs. If you have other kinds of hardware (Netbooks! Windows! Linux!), please try it out and let me know what you find.</p>
